generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Repo {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  stars       Int      @default(0)
  commits     Int      @default(0)
  lastPushed  DateTime
  url         String
  language    String?
  languages   Json?
  isPrivate   Boolean  @default(false)
  isVisible   Boolean  @default(true)
  isFork      Boolean  @default(false)
  isPinned    Boolean  @default(false)
  pinnedOrder Int?
  thumbnail   String?
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("UserRepos", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model User {
  id                    String        @id @default(cuid())
  clerkId               String        @unique
  email                 String        @unique
  name                  String?
  avatarUrl             String?
  bio                   String?
  githubHandle          String?       @unique
  subdomain             String?       @unique // Custom subdomain (e.g., "john" for john.kraftbeast.com)
  githubToken           String?       // Legacy OAuth token (deprecated)
  githubConnected       Boolean       @default(false) // Legacy OAuth flag
  githubInstallationId  String?       // GitHub App installation ID
  githubAppConnected    Boolean       @default(false) // GitHub App connection flag
  twitterHandle         String?
  linkedinUrl           String?
  forwardEmail          String?
  resendApiKey          String?       // Encrypted Resend API key for per-user email forwarding
  defaultRepoView       String        @default("readme")
  timelineRangeFrom     DateTime?     // Timeline range start (null = default 90 days)
  timelineRangeTo       DateTime?     // Timeline range end (null = now)
  accentColor           String        @default("#3b82f6") // Accent color for theme
  lastSyncedAt          DateTime?     // Last GitHub sync timestamp
  visits                Int           @default(0)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  repos                 Repo[]        @relation("UserRepos")
  workHistory           WorkHistory[]
  timeline              Timeline[]
  syncLogs              SyncLog[]
  webhookRetries        WebhookRetry[]
}

model WorkHistory {
  id          String   @id @default(cuid())
  userId      String
  title       String
  company     String
  startDate   String
  endDate     String?
  bullets     String[]
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Timeline {
  id          String   @id @default(cuid())
  userId      String
  repoName    String
  message     String
  timestamp   DateTime
  hidden      Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
}

model SyncLog {
  id          String   @id @default(cuid())
  userId      String
  status      String   // 'success', 'error', 'partial'
  reposSynced Int      @default(0)
  errors      Int      @default(0)
  message     String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model WebhookRetry {
  id          String   @id @default(cuid())
  userId      String
  event       String
  payload     Json
  attempts    Int      @default(0)
  lastAttempt DateTime?
  nextRetry   DateTime?
  status      String   @default("pending") // 'pending', 'success', 'failed'
  error       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([nextRetry])
}
